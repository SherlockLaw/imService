# imService
IM服务端

部署软件环境说明(括号内是开发者使用的软件版本)：

centos6.5, redis(3.2.9), rabbitmq(rabbitmq-server-3.6.6-1.el7), vsftpd(3.0.2-22.el7), nginx(1.12.2),zookeeper(3.4.9)


nginx作为http入口，额外暴露TCP入口（默认8088），加入swagger组件，可做测试

app方可以查看 https://github.com/SherlockLaw/imApp


功能说明

1）用户模块：用户注册，登录，修改

2）联系人模块：好友列表，搜索，添加好友

3）群组模块：群组列表，添加

4）即时消息发送，接收，离线消息获取，消息保证送达机制，消息撤回，已读未读

5）心跳机制，客户端断线重连机制

6）Nginx + Vsftpd 组成图片服务器

7）Zookeeper + Redis 实现高可用的服务集群

登录与验证：客户端登录后，缓存用户基本信息+token，客户端与服务端建立TCP的连接，连接的有效性通过每个包携带的token验证，连接。

客户端消息接收：在线状态，消息通过TCP连接发送到客户端；离线状态，缓存用户总未读数、每个会话的离线未读数和每个会话的离线消息，TCP连接成功了之后通过Http接口从服务端拉取。

客户端的图片缓存：内存缓存（软引用实现），本地文件缓存。


目前仍存在问题：

1、由于离线消息是按照时间顺序存储的，对于服务端的离线消息，存在一些消息未存入离线时，客户端拉取了离线消息，从而导致客户端登陆后有一部分消息拉不到（几率极小，需要在客户端登录的瞬间，服务端存入了离线消息（此线程执行较慢，导致拉取离线消息先拉取），加入收到心跳时检测是否有未读即可解决

2、删除离线消息只加入了时间条件，未加入消息数进行确认（如要保证送达机制，加上个数限制，个数不正确时，让客户端重试即可）
